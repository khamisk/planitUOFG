<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" type="image/png" href="/favicon.png" />

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>planitUOFG</title>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore-compat.js"></script>
<link rel="stylesheet" href="https://unpkg.com/vis-network@9.1.2/dist/vis-network.min.css" />
<script src="https://unpkg.com/vis-network@9.1.2/dist/vis-network.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-analytics-compat.js"></script>

<style>
:root {
  --bg: #020617;
  --card: #0b1120;
  --border: #1e293b;
  --accent: #38bdf8;
  --text: #e5e7eb;
  --muted: #94a3b8;
  --selected: #f97316;
  --direct: #22c55e;
  --indirect: #38bdf8;
}

body {
  margin: 0;
  font-family: system-ui, sans-serif;
  background: radial-gradient(circle at top, #0f172a 0%, #020617 70%);
  color: var(--text);
}

header {
  padding: 1rem 2rem;
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
}

.header-right {
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

main {
  display: grid;
  grid-template-columns: 3fr 2fr;
  gap: 1.5rem;
  max-width: 1600px;
  margin: 1.5rem auto;
  padding: 0 1rem;
}
.card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 0.8rem;
  padding: 1rem;
}
select, button {
  border: 1px solid var(--border);
  border-radius: 0.5rem;
  background: #020617;
  color: var(--text);
  padding: 0.4rem 0.6rem;
  font-size: 0.9rem;
}
button {
  background: var(--accent);
  color: #020617;
  font-weight: 600;
  cursor: pointer;
}
#schedule-container {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}
.year-block {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}
.year-title {
  font-weight: 700;
  font-size: 1.1rem;
  color: var(--accent);
}
.semester-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(270px, 1fr));
  gap: 1rem;
}
.semester-card {
  background: #0f172a;
  border: 1px solid var(--border);
  border-radius: 0.8rem;
  padding: 0.8rem;
  box-shadow: 0 0 6px rgba(0,0,0,0.25);
  transition: 0.25s ease;
}
.semester-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 4px 15px rgba(0,0,0,0.35);
}
.semester-title {
  font-weight: 700;
  margin-bottom: 0.4rem;
  color: var(--accent);
}

/* course cards */
.course-card {
  background: #0b1120;
  border: 1px solid #1e293b;
  border-radius: 0.5rem;
  padding: 0.4rem;
  margin-bottom: 0.4rem;
  cursor: pointer;
  transition: 0.15s ease;
  box-shadow: 0 0 4px rgba(0,0,0,0.25);
}
.course-card:hover { border-color: var(--accent); transform: translateY(-2px); }

.course-inner {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 0.5rem;
}

.course-main-text {
  display: flex;
  flex-direction: column;
  gap: 0.1rem;
}

.course-code { color: var(--accent); font-weight: 600; }

/* small info button inside course card */
.info-btn {
  border-radius: 999px;
  border: 1px solid var(--border);
  background: #020617;
  color: var(--muted);
  font-size: 0.7rem;
  padding: 0.15rem 0.55rem;
  cursor: pointer;
  flex-shrink: 0;
}
.info-btn:hover {
  border-color: var(--accent);
  color: var(--accent);
}

/* highlight classes */
.course-selected { background: rgba(249,115,22,.2); border-color: var(--selected); }
.course-direct { background: rgba(34,197,94,.18); border-color: var(--direct); }
.course-indirect { background: rgba(56,189,248,.15); border-color: var(--indirect); }
/* future courses */
.course-future { background: rgba(167,139,250,.15); border-color: #a78bfa; }

/* compare highlight */
.course-same {
  background: rgba(34,197,94,0.22);
  border-color: #22c55e;
}
.course-diff {
  background: rgba(234,179,8,0.23);
  border-color: #eab308;
}

.legend { font-size: 0.8rem; color: var(--muted); display: flex; gap: 0.7rem; margin: 0.5rem 0; flex-wrap: wrap; }
.legend-dot { width: 10px; height: 10px; border-radius: 999px; display: inline-block; }
.legend-dot.selected { background: var(--selected); }
.legend-dot.direct { background: var(--direct); }
.legend-dot.indirect { background: var(--indirect); }
.legend-dot.future { background: #a78bfa; }


#graph { height: 75vh; border: 1px solid var(--border); border-radius: 0.7rem; background: #020617; }
#status { margin-top: 0.5rem; color: var(--muted); font-size: 0.85rem; }

footer {
  text-align: center;
  font-size: 0.8rem;
  color: var(--muted);
  margin: 1rem 0;
}

/* modal for course info + ratings */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(15,23,42,0.8);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 50;
}

.modal-content {
  background: #020617;
  border-radius: 0.9rem;
  border: 1px solid var(--border);
  max-width: 480px;
  width: 90%;
  padding: 1.2rem 1.4rem 1.1rem 1.4rem;
  box-shadow: 0 20px 40px rgba(0,0,0,0.7);
  position: relative;
}

.modal-close {
  position: absolute;
  top: 0.5rem;
  right: 0.7rem;
  border: none;
  background: transparent;
  color: var(--muted);
  font-size: 1.3rem;
  cursor: pointer;
}

.modal-close:hover {
  color: var(--accent);
}

.modal-title {
  font-size: 1.05rem;
  font-weight: 600;
  margin-bottom: 0.3rem;
}

.modal-desc {
  font-size: 0.85rem;
  color: var(--muted);
  margin-bottom: 0.7rem;
  white-space: pre-line;
}

.modal-section-title {
  font-size: 0.85rem;
  font-weight: 600;
  margin-top: 0.4rem;
  margin-bottom: 0.25rem;
}

/* averages: make numbers a semi-focus */
.modal-averages {
  display: grid;
  grid-template-columns: repeat(3, minmax(0,1fr));
  gap: 0.4rem;
  font-size: 0.85rem;
  margin-bottom: 0.6rem;
}
.modal-averages div {
  text-align: center;
}
.modal-averages div span.value {
  display: block;
  font-weight: 700;
  font-size: 1.2rem;
}

/* rating rows + circle options */
.modal-rating-row {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
  margin-bottom: 0.4rem;
  font-size: 0.8rem;
}

.modal-rating-row label {
  display: flex;
  justify-content: space-between;
}

.modal-rating-options {
  display: flex;
  flex-wrap: wrap;
  gap: 0.3rem;
  margin-top: 0.15rem;
}

.rating-circle {
  width: 24px;
  height: 24px;
  border-radius: 999px;
  border: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.7rem;
  color: var(--muted);
  background: transparent;
  cursor: pointer;
  padding: 0;
}
.rating-circle:hover {
  border-color: var(--accent);
  color: var(--accent);
}
.rating-circle.selected {
  background: var(--accent);
  border-color: var(--accent);
  color: #020617;
}

#rating-submit {
  margin-top: 0.4rem;
  width: 100%;
  font-size: 0.9rem;
}

/* === Responsive layout for mobile only === */
@media (max-width: 900px) {
  main {
    grid-template-columns: 1fr;
  }
  .card { padding: 0.8rem; }
  header {
    flex-direction: column;
    align-items: flex-start;
    gap: 0.5rem;
  }
  .controls {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }
  select, button {
    width: 100%;
    font-size: 1rem;
  }
  #graph { height: 60vh; }
  .semester-grid { grid-template-columns: 1fr; }
  .semester-card { padding: 0.7rem; }
  .year-title {
    font-size: 1rem;
    text-align: center;
  }
  footer {
    font-size: 0.7rem;
    margin-top: 2rem;
  }
}

@media (max-width: 600px) {
  .info-btn {
    font-size: 0.65rem;
    padding: 0.1rem 0.4rem;
    white-space: nowrap;
    max-width: fit-content;
  }
}

/* === Mobile-only modal fixes === */
@media (max-width: 900px) {
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(15, 23, 42, 0.9);
    display: none;
    justify-content: center;
    align-items: flex-start;
    overflow-y: auto;
    padding: 1rem;
    z-index: 200;
    -webkit-overflow-scrolling: touch;
  }

  .modal-content {
    width: 100%;
    max-width: 95%;
    margin: 1.5rem auto;
    border-radius: 0.8rem;
    max-height: 90vh;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
  }

  .modal-close {
    position: sticky;
    top: 0;
    right: 0;
    background: transparent;
    font-size: 1.6rem;
    color: var(--muted);
    float: right;
    z-index: 5;
  }

  body.modal-open {
    overflow: hidden;
    height: 100vh;
  }
}

/* prevent horizontal scroll in modal on mobile */
.modal-content {
  overflow-x: hidden;
  max-width: 100vw;
  box-sizing: border-box;
}

/* === Fix Search Modal on Desktop === */
#search-modal .modal-content {
  max-width: 420px;
  width: 90%;
  padding: 1.5rem 1.7rem;
  border-radius: 0.9rem;
  text-align: center;
}

#search-modal input {
  font-size: 0.95rem;
}

#search-modal button {
  font-size: 0.95rem;
}

/* Center vertically on desktop */
@media (min-width: 901px) {
  #search-modal {
    align-items: center !important;
  }
}
/* === Comparison Layout Fix === */
.comparison-wrap {
  display: grid;
  grid-template-rows: auto auto;
  gap: 1rem;
}

/* Force 2x3 layout even on mobile */
.comparison-wrap > .semester-grid {
  display: grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap: 0.8rem;
}

/* Each semester card should be equal width */
.comparison-wrap .semester-card {
  min-width: 0;
}

/* On smaller devices, keep same 3-column format with horizontal scroll if needed */
@media (max-width: 900px) {
  .comparison-wrap > .semester-grid {
    grid-template-columns: repeat(3, 270px);
    overflow-x: auto;
    padding-bottom: 0.5rem;
  }
  .comparison-wrap .semester-card {
    flex-shrink: 0;
  }
}
/* === Mobile Comparison Card Size Adjustment === */
@media (max-width: 900px) {
  /* slightly smaller semester cards and text */
  .comparison-wrap .semester-card {
    transform: scale(0.92);
    transform-origin: top left;
    padding: 0.5rem;
    border-radius: 0.6rem;
  }

  .comparison-wrap .semester-title {
    font-size: 0.85rem;
  }

  .comparison-wrap .course-card {
    font-size: 0.8rem;
    padding: 0.3rem;
    margin-bottom: 0.3rem;
  }

  .comparison-wrap .course-code {
    font-size: 0.85rem;
  }

  .comparison-wrap .course-inner {
    gap: 0.3rem;
  }

  /* maintain scrollable 3-column layout but tighter */
  .comparison-wrap > .semester-grid {
    grid-template-columns: repeat(3, 230px);
    gap: 0.6rem;
  }
}


</style>

</head>
<body>
<header style="display:flex;align-items:center;justify-content:space-between;">
  <div style="display:flex;align-items:center;gap:10px;">
    <img src="/favicon.png" alt="planitUOFG logo" style="height:45px;width:auto;">
    <h1>planitUOFG</h1>
  </div>
  <div class="header-right">
    <small>last updated: 2025-11-08</small>
  </div>
</header>

<main>
  <section class="card">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:0.5rem;flex-wrap:wrap;">
      <h2>Program Schedule</h2>
      <div style="display:flex;gap:0.4rem;flex-wrap:wrap;">
        <button id="search-btn" style="background:#38bdf8;color:#020617;border:none;border-radius:6px;padding:0.3rem 0.7rem;font-weight:600;cursor:pointer;">
          Search Course
        </button>
        <button id="howto-btn" style="background:#38bdf8;color:#020617;border:none;border-radius:6px;padding:0.3rem 0.7rem;font-weight:600;cursor:pointer;">
          How to use
        </button>
      </div>
    </div>

    <div class="controls">
      <select id="year-select"></select>
      <select id="program-select"></select>
      <input id="program-filter" type="text" placeholder="Filter programs..."
             style="width:100%;margin-top:0.4rem;margin-bottom:0.4rem;
                    background:#0b1120;border:1px solid var(--border);
                    color:var(--text);border-radius:0.5rem;padding:0.4rem 0.6rem;">
      <button id="load-btn">Load</button>
        <button id="toggle-compare">+ Compare another program</button>

    </div>

    <!-- compare controls -->
    <div class="controls" id="compare-controls" style="display:none;margin-top:0.75rem;border-top:1px solid var(--border);padding-top:0.75rem;">

      <select id="compare-year-select"></select>
      <select id="compare-program-select"></select>
      <input id="compare-program-filter" type="text" placeholder="Filter second program..."
             style="width:100%;margin-top:0.4rem;margin-bottom:0.4rem;
                    background:#0b1120;border:1px solid var(--border);
                    color:var(--text);border-radius:0.5rem;padding:0.4rem 0.6rem;">
      <button id="compare-btn">Compare Programs</button>
    </div>

    <div id="program-summary"></div>
    <div id="schedule-container"></div>
    <div id="compare-status" style="margin-top:0.75rem;font-size:0.85rem;color:var(--muted);"></div>
    <div id="compare-container" style="margin-top:0.75rem;"></div>
    <div id="status"></div>
  </section>

  <section class="card">
    <h2>Prerequisite Graph</h2>
    <div class="legend">
      <span><span class="legend-dot selected"></span>Selected</span>
      <span><span class="legend-dot direct"></span>Direct prereq</span>
      <span><span class="legend-dot indirect"></span>Indirect prereq</span>
      <span><span class="legend-dot future"></span>Future course</span>
    </div>
    <div style="display:flex;flex-wrap:wrap;gap:0.75rem;font-size:0.8rem;color:#94a3b8;margin-bottom:0.6rem;">
      <label><input type="checkbox" id="toggle-selected" checked>Selected</label>
      <label><input type="checkbox" id="toggle-direct" checked>Direct</label>
      <label><input type="checkbox" id="toggle-indirect" checked>Indirect</label>
      <label><input type="checkbox" id="toggle-future" checked>Future</label>
    </div>
    <div id="graph"></div>
  </section>

</main>

<!-- course info + ratings modal -->
<div id="course-modal" class="modal-overlay">
  <div class="modal-content" style="max-width:900px;display:flex;flex-direction:row;gap:1.2rem;flex-wrap:wrap;">
    <button id="course-modal-close" class="modal-close">&times;</button>

    <!-- LEFT SIDE: Info + Ratings -->
    <div style="flex:1 1 400px;min-width:340px;">
      <div class="modal-title" id="course-modal-title"></div>
      <div class="modal-desc" id="course-modal-desc"></div>

      <div class="modal-section-title">What other students rated</div>
      <div class="modal-averages">
        <div>Difficulty<span class="value" id="avg-diff">–</span>/10</div>
        <div>Workload<span class="value" id="avg-work">–</span>/10</div>
        <div>Enjoyability<span class="value" id="avg-enjoy">–</span>/10</div>
      </div>
      <div id="rating-count" style="text-align:center;font-size:0.8rem;color:#94a3b8;margin-top:-0.3rem;margin-bottom:0.5rem;">
        as rated by 0 users
      </div>

      <div class="modal-section-title">Taken this course? Rate it</div>

      <div class="modal-rating-row">
        <label><span>Difficulty (1 = easy, 10 = impossible)</span><span><span id="val-diff">–</span>/10</span></label>
        <div class="modal-rating-options" id="opts-diff">
          <button type="button" class="rating-circle" data-value="1">1</button>
          <button type="button" class="rating-circle" data-value="2">2</button>
          <button type="button" class="rating-circle" data-value="3">3</button>
          <button type="button" class="rating-circle" data-value="4">4</button>
          <button type="button" class="rating-circle" data-value="5">5</button>
          <button type="button" class="rating-circle" data-value="6">6</button>
          <button type="button" class="rating-circle" data-value="7">7</button>
          <button type="button" class="rating-circle" data-value="8">8</button>
          <button type="button" class="rating-circle" data-value="9">9</button>
          <button type="button" class="rating-circle" data-value="10">10</button>
        </div>
      </div>

      <div class="modal-rating-row">
        <label><span>Workload (1 = none, 10 = lots)</span><span><span id="val-work">–</span>/10</span></label>
        <div class="modal-rating-options" id="opts-work">
          <button type="button" class="rating-circle" data-value="1">1</button>
          <button type="button" class="rating-circle" data-value="2">2</button>
          <button type="button" class="rating-circle" data-value="3">3</button>
          <button type="button" class="rating-circle" data-value="4">4</button>
          <button type="button" class="rating-circle" data-value="5">5</button>
          <button type="button" class="rating-circle" data-value="6">6</button>
          <button type="button" class="rating-circle" data-value="7">7</button>
          <button type="button" class="rating-circle" data-value="8">8</button>
          <button type="button" class="rating-circle" data-value="9">9</button>
          <button type="button" class="rating-circle" data-value="10">10</button>
        </div>
      </div>

      <div class="modal-rating-row">
        <label><span>Enjoyability (1 = none, 10 = lots)</span><span><span id="val-enjoy">–</span>/10</span></label>
        <div class="modal-rating-options" id="opts-enjoy">
          <button type="button" class="rating-circle" data-value="1">1</button>
          <button type="button" class="rating-circle" data-value="2">2</button>
          <button type="button" class="rating-circle" data-value="3">3</button>
          <button type="button" class="rating-circle" data-value="4">4</button>
          <button type="button" class="rating-circle" data-value="5">5</button>
          <button type="button" class="rating-circle" data-value="6">6</button>
          <button type="button" class="rating-circle" data-value="7">7</button>
          <button type="button" class="rating-circle" data-value="8">8</button>
          <button type="button" class="rating-circle" data-value="9">9</button>
          <button type="button" class="rating-circle" data-value="10">10</button>
        </div>
      </div>

      <button id="rating-submit">Submit rating</button>
    </div>

    <!-- RIGHT SIDE: Mini Graph -->
    <div style="flex:1 1 400px;min-width:320px;">
      <div id="mini-graph" style="height:400px;border:1px solid var(--border);border-radius:0.6rem;background:#020617;"></div>
    </div>
  </div>
</div>
<!-- end of course modal -->

<!-- how-to modal -->
<div id="howto-modal" class="modal-overlay">
  <div class="modal-content">
    <button id="howto-close" class="modal-close">&times;</button>
    <div class="modal-title">How to use:</div>
    <div class="modal-desc">
      1. Select a <b>calendar year</b> and <b>program</b> from the dropdowns.<br><br>
      2. Click <b>Load</b> to see your full semester-by-semester program layout.<br><br>
      3. Hover or click on courses to view <b>descriptions</b> and <b>rate difficulty, workload, and enjoyability</b>.<br><br>
      4. The <b>graph on the right (bottom, on mobile) </b> shows prerequisites and future course dependencies.<br><br>
      5. Use the <b>checkboxes</b> to toggle visibility of selected, direct, indirect, and future courses.<br><br>
      The more ratings, the more features I can add to benefit YOU<br><br>
      such as, a section for easy courses ( by year, prereqs ), hardest for certain programs, etc
    </div>
  </div>
</div>

<!-- search modal -->
<div id="search-modal" class="modal-overlay">
  <div class="modal-content">
    <button id="search-close" class="modal-close">&times;</button>
    <div class="modal-title">Search for a Course</div>
    <div class="modal-desc">
      Enter a course code (e.g. CIS*1300, cis1300, cis 1300)
    </div>
    <input id="search-input" type="text" placeholder="Enter course code"
           style="width:100%;padding:0.5rem 0.7rem;margin-bottom:0.6rem;
                  background:#0b1120;border:1px solid var(--border);
                  color:var(--text);border-radius:0.5rem;">
    <button id="search-submit" style="width:100%;background:var(--accent);
             color:#020617;border:none;border-radius:0.5rem;
             padding:0.5rem;font-weight:600;cursor:pointer;">
      Search
    </button>
    <div id="search-status" style="margin-top:0.7rem;font-size:0.85rem;color:var(--muted);text-align:center;"></div>
  </div>
</div>

<footer>2025, contact @karimzxzxzx on instagram for any questions / suggestions </footer>
<footer>not an official uofguelph website, no association or affiliation with them</footer>

<script>
const firebaseConfig = {
  apiKey: "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX",
  authDomain: "planituofg.firebaseapp.com",
  projectId: "planituofg",
  storageBucket: "planituofg.firebasestorage.app",
  messagingSenderId: "763826736407",
  appId: "1:763826736407:web:fc294315388b2fbeb7bb52"
};
firebase.initializeApp(firebaseConfig);
const analytics = firebase.analytics();
const db = firebase.firestore();

const yearSel=document.getElementById("year-select"),
      progSel=document.getElementById("program-select"),
      loadBtn=document.getElementById("load-btn"),
      scheduleContainer=document.getElementById("schedule-container"),
      summary=document.getElementById("program-summary"),
      statusEl=document.getElementById("status");
const toggles={
  selected:document.getElementById("toggle-selected"),
  direct:document.getElementById("toggle-direct"),
  indirect:document.getElementById("toggle-indirect"),
  future:document.getElementById("toggle-future")
};

const compareYearSel=document.getElementById("compare-year-select"),
      compareProgSel=document.getElementById("compare-program-select"),
      compareBtn=document.getElementById("compare-btn"),
      compareContainer=document.getElementById("compare-container"),
      compareStatusEl=document.getElementById("compare-status"),
      compareProgramFilter=document.getElementById("compare-program-filter");

/* modal refs */
const modal = document.getElementById("course-modal");
const modalTitle = document.getElementById("course-modal-title");
const modalDesc = document.getElementById("course-modal-desc");
const avgDiffEl = document.getElementById("avg-diff");
const avgWorkEl = document.getElementById("avg-work");
const avgEnjoyEl = document.getElementById("avg-enjoy");
const valDiff = document.getElementById("val-diff");
const valWork = document.getElementById("val-work");
const valEnjoy = document.getElementById("val-enjoy");
const optsDiff = document.getElementById("opts-diff");
const optsWork = document.getElementById("opts-work");
const optsEnjoy = document.getElementById("opts-enjoy");
const ratingSubmit = document.getElementById("rating-submit");
const modalClose = document.getElementById("course-modal-close");

let programsByYear={},currentYear=null,currentProg=null;
let programCodes=new Set(),courseMeta={},courseEls={},nodeSet,network;
let currentModalCourse = null;

/* current chosen ratings for this browser session (per open modal) */
let currentDiff = null;
let currentWork = null;
let currentEnjoy = null;

/* anonymous rater id per browser */
let raterId = localStorage.getItem("planit_rater_id");
if (!raterId) {
  raterId = "r_" + Math.random().toString(36).slice(2) + Date.now().toString(36);
  localStorage.setItem("planit_rater_id", raterId);
}

function setStatus(t,e=false){statusEl.textContent=t;statusEl.style.color=e?"#f87171":"#94a3b8";}
function setCompareStatus(t,e=false){compareStatusEl.textContent=t;compareStatusEl.style.color=e?"#f87171":"#94a3b8";}

/* === helper to trim long descriptions at prerequisites, etc. === */
function cleanDescription(text){
  if(!text) return "No description available yet.";
  const cutoff = text.search(/Prerequisite|Restriction|Department|Offering|Location/i);
  if(cutoff > 0){
    text = text.slice(0, cutoff);
  }
  return text.trim();
}

/* === PROGRAM INDEX (skip empty ones) === */
async function buildIndex(){
  const snap=await db.collection("programs").get();
  programsByYear={};
  for(const doc of snap.docs){
    if(doc.id.startsWith("#"))continue;
    const data=doc.data();
    if(!data.semesters||!data.semesters.length)continue;
    const hasContent=data.semesters.some(s=>(s.courses&&s.courses.some(c=>c.code||c.name))||(s.title&&/(Semester|Fall|Winter|Summer)/i.test(s.title)));
    if(!hasContent)continue;
    const id=doc.id;
    const parts=id.split("_");
    const yr=parts.pop();
    const mode=parts.pop();
    const name=parts.join("-").replace(/-/g," ").replace(/\b\w/g,x=>x.toUpperCase());
    const label=name+(mode==="coop"?" (Co-op)":"");
    if(!programsByYear[yr])programsByYear[yr]=[];
    programsByYear[yr].push({id,label});
  }
  const years=Object.keys(programsByYear).sort();
  yearSel.innerHTML=years.map(y=>`<option>${y}</option>`).join("");
  currentYear=years.at(-1);
  yearSel.value=currentYear;
  populatePrograms();
  populateCompareDropdowns();
  setStatus("Programs loaded.");
}

function populatePrograms(){
  progSel.innerHTML="";
  for(const p of programsByYear[currentYear]||[])
    progSel.innerHTML+=`<option value="${p.id}">${p.label}</option>`;
  currentProg=progSel.value;
}

function populateCompareDropdowns(){
  const years = Object.keys(programsByYear).sort();
  compareYearSel.innerHTML = years.map(y=>`<option>${y}</option>`).join("");
  compareYearSel.value = currentYear || years.at(-1);
  populateComparePrograms();
}

function populateComparePrograms(){
  compareProgSel.innerHTML = "";
  const list = programsByYear[compareYearSel.value] || [];
  for(const p of list){
    const opt = document.createElement("option");
    opt.value = p.id;
    opt.textContent = p.label;
    compareProgSel.appendChild(opt);
  }
}

/* === Program filter === */
const programFilter = document.getElementById("program-filter");

programFilter.addEventListener("input", () => {
  const filter = programFilter.value.toLowerCase();
  progSel.innerHTML = "";

  const list = programsByYear[currentYear] || [];
  const filtered = list.filter(p => p.label.toLowerCase().includes(filter));

  for (const p of filtered) {
    const opt = document.createElement("option");
    opt.value = p.id;
    opt.textContent = p.label;
    progSel.appendChild(opt);
  }

  if (filtered.length) {
    currentProg = progSel.value;
  }
});

/* === Compare program filter === */
compareProgramFilter.addEventListener("input", () => {
  const filter = compareProgramFilter.value.toLowerCase();
  compareProgSel.innerHTML = "";

  const list = programsByYear[compareYearSel.value] || [];
  const filtered = list.filter(p => p.label.toLowerCase().includes(filter));

  for (const p of filtered) {
    const opt = document.createElement("option");
    opt.value = p.id;
    opt.textContent = p.label;
    compareProgSel.appendChild(opt);
  }
});

yearSel.onchange=()=>{currentYear=yearSel.value;populatePrograms();};
progSel.onchange=()=>currentProg=progSel.value;
compareYearSel.onchange=()=>{
  compareProgramFilter.value = "";
  populateComparePrograms();
};

loadBtn.onclick=async()=>{
  if(!currentProg)return;
  setStatus("Loading...");
  const doc=await db.collection("programs").doc(currentProg).get();
  if(!doc.exists)return setStatus("Not found",true);
  const data=doc.data();
  renderSchedule(data.semesters||[]);
  await loadCourseMeta(currentYear);
  buildGraph();
  const parts=currentProg.split("_");
  const yr=parts.pop(),mode=parts.pop();
  const n=parts.join("-").replace(/-/g," ").replace(/\b\w/g,x=>x.toUpperCase());
  summary.innerHTML=`<b>${n}${mode==="coop"?" (Co-op)":""}</b> · ${yr}`;
  setStatus("Loaded.");
};

/* === RENDER PROGRAM STRUCTURE === */
function renderSchedule(sems){
  scheduleContainer.innerHTML="";
  programCodes.clear();
  courseEls={};
  let rec=sems.find(s=>s.title&&s.title.toLowerCase().includes("recommended program sequence"));
  if(!rec){
    rec=sems.find(s=>s.courses&&s.courses.some(c=>c.text&&/(Semester\s*\d+|Fall Semester|Winter Semester|Summer Semester)/i.test(c.text))&&!/Academic and Co-?op Work Term Schedule/i.test(s.title));
  }
  if(!rec||!rec.courses){
    if(sems.length&&sems[0].courses&&sems[0].courses.length){
      const only=sems[0];
      const card=document.createElement("div");
      card.className="semester-card";
      card.innerHTML=`<div class="semester-title">${only.title||"Program Overview"}</div>`;
      only.courses.forEach(c=>{
        const code=c.code||"",name=c.name||c.text||"";
        const div=document.createElement("div");
        div.className="course-card";
        const inner=document.createElement("div");
        inner.className="course-inner";
        const textWrap=document.createElement("div");
        textWrap.className="course-main-text";
        if(code){
          const codeEl=document.createElement("div");
          codeEl.className="course-code";
          codeEl.textContent=code;
          const nameEl=document.createElement("div");
          nameEl.textContent=name;
          textWrap.appendChild(codeEl);
          textWrap.appendChild(nameEl);
        }else{
          const nameEl=document.createElement("div");
          nameEl.textContent=name;
          textWrap.appendChild(nameEl);
        }
        inner.appendChild(textWrap);
        div.appendChild(inner);
        card.appendChild(div);
      });
      const wrap=document.createElement("div");
      wrap.className="year-block";
      const title=document.createElement("div");
      title.className="year-title";
      title.textContent="Program Overview";
      const grid=document.createElement("div");
      grid.className="semester-grid";
      grid.appendChild(card);
      wrap.appendChild(title);
      wrap.appendChild(grid);
      scheduleContainer.appendChild(wrap);
      return;
    }
    return setStatus("No semester data found",true);
  }
  const semesters=[];
  let currentSem=null;
  for(const item of rec.courses){
    if(item.text&&/(Semester\s*\d+|Fall Semester|Winter Semester|Summer Semester)/i.test(item.text)){
      if(currentSem)semesters.push(currentSem);
      currentSem={title:item.text.trim(),courses:[]};
    }else if(item.code||(item.text&&!/Semester/i.test(item.text))){
      if(!currentSem)currentSem={title:"Misc",courses:[]};
      currentSem.courses.push(item);
    }
  }
  if(currentSem)semesters.push(currentSem);
  if(!semesters.length)return setStatus("No semesters detected",true);

  let yearCount=1;
  let currentRow=document.createElement("div");
  currentRow.className="semester-grid";
  let yearBlock=document.createElement("div");
  yearBlock.className="year-block";
  let yearTitle=document.createElement("div");
  yearTitle.className="year-title";
  yearTitle.textContent=`Year ${yearCount}`;
  yearBlock.appendChild(yearTitle);
  yearBlock.appendChild(currentRow);

  semesters.forEach((sem,i)=>{
    const card=document.createElement("div");
    card.className="semester-card";
    card.innerHTML=`<div class="semester-title">${sem.title}</div>`;
    sem.courses.forEach(c=>{
      const code=c.code||"";
      const name=c.name||c.text||"";
      const div=document.createElement("div");
      div.className="course-card";
      if(code){
        div.dataset.code=code;
        div.dataset.name=name;
        div.onclick=()=>selectCourse(code);
        programCodes.add(code);
        if(!courseEls[code])courseEls[code]=[];
        courseEls[code].push(div);
      }
      const inner=document.createElement("div");
      inner.className="course-inner";

      const textWrap=document.createElement("div");
      textWrap.className="course-main-text";
      if(code){
        const codeEl=document.createElement("div");
        codeEl.className="course-code";
        codeEl.textContent=code;
        const nameEl=document.createElement("div");
        nameEl.textContent=name;
        textWrap.appendChild(codeEl);
        textWrap.appendChild(nameEl);
      }else{
        const nameEl=document.createElement("div");
        nameEl.textContent=name;
        textWrap.appendChild(nameEl);
      }
      inner.appendChild(textWrap);

      if(code){
        const infoBtn=document.createElement("button");
        infoBtn.type="button";
        infoBtn.className="info-btn";
        infoBtn.textContent="info";
        infoBtn.onclick=(ev)=>{
          ev.stopPropagation();
          openCourseModal(code,name);
        };
        inner.appendChild(infoBtn);
      }

      div.appendChild(inner);
      card.appendChild(div);
    });
    currentRow.appendChild(card);
    if((i+1)%3===0||i===semesters.length-1){
      scheduleContainer.appendChild(yearBlock);
      yearCount++;
      currentRow=document.createElement("div");
      currentRow.className="semester-grid";
      yearBlock=document.createElement("div");
      yearBlock.className="year-block";
      yearTitle=document.createElement("div");
      yearTitle.className="year-title";
      yearTitle.textContent=`Year ${yearCount}`;
      yearBlock.appendChild(yearTitle);
      yearBlock.appendChild(currentRow);
    }
  });
}

/* === helper: extract semesters for comparison === */
function extractSemestersForCompare(sems){
  let rec=sems.find(s=>s.title&&s.title.toLowerCase().includes("recommended program sequence"));
  if(!rec){
    rec=sems.find(s=>s.courses&&s.courses.some(c=>c.text&&/(Semester\s*\d+|Fall Semester|Winter Semester|Summer Semester)/i.test(c.text))&&!/Academic and Co-?op Work Term Schedule/i.test(s.title));
  }
  const semesters=[];
  if(!rec||!rec.courses) return semesters;
  let currentSem=null;
  for(const item of rec.courses){
    if(item.text&&/(Semester\s*\d+|Fall Semester|Winter Semester|Summer Semester)/i.test(item.text)){
      if(currentSem)semesters.push(currentSem);
      currentSem={title:item.text.trim(),courses:[]};
    }else if(item.code||(item.text&&!/Semester/i.test(item.text))){
      if(!currentSem)currentSem={title:"Misc",courses:[]};
      currentSem.courses.push(item);
    }
  }
  if(currentSem)semesters.push(currentSem);
  return semesters;
}

function buildCompareSemesterCard(sem, title, sameCodes, diffCodes){
  const card=document.createElement("div");
  card.className="semester-card";
  const t=document.createElement("div");
  t.className="semester-title";
  t.textContent=title;
  card.appendChild(t);

  if(!sem || !sem.courses || !sem.courses.length){
    const empty=document.createElement("div");
    empty.style.fontSize="0.85rem";
    empty.style.color="var(--muted)";
    empty.textContent="No courses listed.";
    card.appendChild(empty);
    return card;
  }

  sem.courses.forEach(c=>{
    const code=c.code||"";
    const name=c.name||c.text||"";
    const div=document.createElement("div");
    div.className="course-card";

    if(code){
      if(sameCodes.has(code)) div.classList.add("course-same");
      else if(diffCodes.has(code)) div.classList.add("course-diff");
    }

    const inner=document.createElement("div");
    inner.className="course-inner";

    const textWrap=document.createElement("div");
    textWrap.className="course-main-text";
    if(code){
      const codeEl=document.createElement("div");
      codeEl.className="course-code";
      codeEl.textContent=code;
      const nameEl=document.createElement("div");
      nameEl.textContent=name;
      textWrap.appendChild(codeEl);
      textWrap.appendChild(nameEl);
    }else{
      const nameEl=document.createElement("div");
      nameEl.textContent=name;
      textWrap.appendChild(nameEl);
    }
    inner.appendChild(textWrap);

if(code){
  const infoBtn=document.createElement("button");
  infoBtn.type="button";
  infoBtn.className="info-btn";
  infoBtn.textContent="info";
  infoBtn.onclick=(ev)=>{
    ev.stopPropagation();
    openCourseModal(code,name);
  };
  inner.appendChild(infoBtn);
}


    div.appendChild(inner);
    card.appendChild(div);
  });

  return card;
}

function renderProgramComparison(sems1, sems2, label1, label2) {
  const list1 = extractSemestersForCompare(sems1);
  const list2 = extractSemestersForCompare(sems2);

  const map1 = new Map(), map2 = new Map();
  list1.forEach((sem, idx) => (sem.courses || []).forEach(c => {
    if (c.code && !map1.has(c.code)) map1.set(c.code, idx);
  }));
  list2.forEach((sem, idx) => (sem.courses || []).forEach(c => {
    if (c.code && !map2.has(c.code)) map2.set(c.code, idx);
  }));

  const sameCodes = new Set(), diffCodes = new Set();
  for (const code of map1.keys()) {
    if (map2.has(code)) {
      if (map1.get(code) === map2.get(code)) sameCodes.add(code);
      else diffCodes.add(code);
    }
  }

  // === container + header ===
  const container = document.createElement("div");
  container.style.display = "flex";
  container.style.flexDirection = "column";
  container.style.gap = "0.75rem";

  const header = document.createElement("div");
  header.innerHTML = `
    <div style="display:flex;flex-direction:column;gap:0.25rem;">
      <div style="font-weight:600;color:var(--accent);font-size:1rem;">
        Comparing <span style="color:#38bdf8;">${label1}</span>
        <span style="color:var(--muted);">vs</span>
        <span style="color:#f87171;">${label2}</span>
      </div>
      <div style="font-size:0.8rem;color:var(--muted);">
        <span style="color:#22c55e;">●</span> same course same semester &nbsp;
        <span style="color:#eab308;">●</span> same course different semester &nbsp;
        <span style="color:#38bdf8;">●</span> ${label1} &nbsp;
        <span style="color:#f87171;">●</span> ${label2}
      </div>
    </div>
  `;
  container.appendChild(header);

  // === build comparison directly ===
  const comparisonWrap = document.createElement("div");
  comparisonWrap.style.display = "flex";
  comparisonWrap.style.flexDirection = "column";
  comparisonWrap.style.gap = "1.5rem";

  const maxLen = Math.max(list1.length, list2.length);
  let yearNum = 1;

  for (let i = 0; i < maxLen; i += 3) {
    const yearBlock = document.createElement("div");
    yearBlock.className = "year-block";
    yearBlock.style.marginBottom = "2rem";

    const yearTitle = document.createElement("div");
    yearTitle.className = "year-title";
    yearTitle.textContent = `Year ${yearNum}`;
    yearBlock.appendChild(yearTitle);

    const wrap = document.createElement("div");
    wrap.style.display = "grid";
wrap.style.gridTemplateColumns = "1fr";
wrap.style.rowGap = "1rem";
wrap.classList.add("comparison-wrap");


    const slice1 = list1.slice(i, i + 3);
    const slice2 = list2.slice(i, i + 3);

    const row1 = document.createElement("div");
    row1.className = "semester-grid";
    slice1.forEach((sem, idx) => {
      const title = `Semester ${i + idx + 1} – ${sem.title || ""}`;
      const card = buildCompareSemesterCard(sem, title, sameCodes, diffCodes);
      card.style.borderColor = "#38bdf8";
      card.style.background = "rgba(56,189,248,0.05)";
      row1.appendChild(card);
    });

    const row2 = document.createElement("div");
    row2.className = "semester-grid";
    slice2.forEach((sem, idx) => {
      const title = `Semester ${i + idx + 1} – ${sem.title || ""}`;
      const card = buildCompareSemesterCard(sem, title, sameCodes, diffCodes);
      card.style.borderColor = "#f87171";
      card.style.background = "rgba(248,113,113,0.05)";
      row2.appendChild(card);
    });

    wrap.appendChild(row1);
    wrap.appendChild(row2);
    yearBlock.appendChild(wrap);
    comparisonWrap.appendChild(yearBlock);
    yearNum++;
  }

  container.appendChild(comparisonWrap);
return container;

}

/* === COMPARE FEATURE === */
compareBtn.onclick = async () => {
  const prog1Id = currentProg;
  const prog2Id = compareProgSel.value;
  const year1 = currentYear;
  const year2 = compareYearSel.value;

  if (!prog1Id || !prog2Id || !year1 || !year2) {
    setCompareStatus("Select both programs and years first.", true);
    return;
  }

  setCompareStatus("Loading comparison...");
  compareContainer.innerHTML = "";

  try {
    const [doc1, doc2] = await Promise.all([
      db.collection("programs").doc(prog1Id).get(),
      db.collection("programs").doc(prog2Id).get()
    ]);

    if (!doc1.exists || !doc2.exists) {
      setCompareStatus("One of the selected programs was not found.", true);
      return;
    }

    const data1 = doc1.data();
    const data2 = doc2.data();

    const prog1Label = (progSel.options[progSel.selectedIndex] || {}).textContent || prog1Id;
    const prog2Label = (compareProgSel.options[compareProgSel.selectedIndex] || {}).textContent || prog2Id;

    compareContainer.innerHTML = renderProgramComparison(data1.semesters || [], data2.semesters || [], prog1Label, prog2Label);
    setCompareStatus("Comparison loaded.");
  } catch (e) {
    console.error(e);
    setCompareStatus("Failed to load comparison.", true);
  }
};



/* === COMPARE FEATURE === */
compareBtn.onclick = async () => {
  const prog1Id = currentProg;
  const prog2Id = compareProgSel.value;
  const year1 = currentYear;
  const year2 = compareYearSel.value;

  if (!prog1Id || !prog2Id || !year1 || !year2) {
    setCompareStatus("Select both programs and years first.", true);
    return;
  }

  setCompareStatus("Loading comparison...");
  compareContainer.innerHTML = "";

  try {
    const [doc1, doc2] = await Promise.all([
      db.collection("programs").doc(prog1Id).get(),
      db.collection("programs").doc(prog2Id).get()
    ]);

    if (!doc1.exists || !doc2.exists) {
      setCompareStatus("One of the selected programs was not found.", true);
      return;
    }

    const data1 = doc1.data();
    const data2 = doc2.data();

    const prog1Label = (progSel.options[progSel.selectedIndex] || {}).textContent || prog1Id;
    const prog2Label = (compareProgSel.options[compareProgSel.selectedIndex] || {}).textContent || prog2Id;

    // replace the main schedule with the comparison view
scheduleContainer.innerHTML = "";
scheduleContainer.appendChild(
  renderProgramComparison(data1.semesters || [], data2.semesters || [], prog1Label, prog2Label)
);


compareContainer.innerHTML = ""; // clear any old comparison block
compareContainer.style.display = "none";
setCompareStatus("Comparison loaded.");

    setCompareStatus("Comparison loaded.");
  } catch (e) {
    console.error(e);
    setCompareStatus("Failed to load comparison.", true);
  }
};

const toggleCompareBtn = document.getElementById("toggle-compare");
const compareControls = document.getElementById("compare-controls");
let compareVisible = false;

toggleCompareBtn.onclick = async () => {
  compareVisible = !compareVisible;
  compareControls.style.display = compareVisible ? "block" : "none";
  toggleCompareBtn.textContent = compareVisible ? "– Hide comparison menu" : "+ Compare another program";

  // when hiding comparison, reload the single main program
  if (!compareVisible && currentProg) {
    setStatus("Restoring main program...");
    const doc = await db.collection("programs").doc(currentProg).get();
    if (doc.exists) {
      renderSchedule(doc.data().semesters || []);
      summary.innerHTML = progSel.options[progSel.selectedIndex].textContent;
      setStatus("Loaded.");
    } else {
      setStatus("Program not found", true);
    }
  }
};


/* === COURSE META (for prereqs + descriptions) === */
async function loadCourseMeta(year){
  courseMeta={};
  const codes=[...programCodes];
  await Promise.all(codes.map(async code=>{
    const ref=db.collection("courses").doc(`${code}_${year}`);
    const snap=await ref.get();
    courseMeta[code]=snap.exists?snap.data():{prereqs:[]};
  }));
}

/* === GRAPH BUILD === */
function buildGraph(){
  const nodes=[],edges=[];
  const indeg={},levels={};
  for(const c of programCodes)indeg[c]=0;
  for(const[c,m]of Object.entries(courseMeta))
    for(const p of(m.prereqs||[]))
      if(programCodes.has(p))indeg[c]=(indeg[c]||0)+1;
  let cur=1;let layer=[...programCodes].filter(c=>!indeg[c]);
  while(layer.length){
    for(const c of layer)levels[c]=cur;
    const next=[];
    for(const c of programCodes){
      for(const p of(courseMeta[c]?.prereqs||[]))
        if(programCodes.has(p)&&levels[p]===cur)indeg[c]--;
    }
    for(const[k,v]of Object.entries(indeg))
      if(v===0&&!levels[k])next.push(k);
    layer=next;cur++;
  }
  for(const c of programCodes)if(!levels[c])levels[c]=cur;
  for(const c of programCodes)nodes.push({id:c,label:c,level:levels[c]});
  for(const[c,m]of Object.entries(courseMeta))
    for(const p of(m.prereqs||[]))
      if(programCodes.has(p))edges.push({from:p,to:c,arrows:"to"});
  nodeSet=new vis.DataSet(nodes);
  const edgeSet=new vis.DataSet(edges);
  const data={nodes:nodeSet,edges:edgeSet};
  const opts={layout:{hierarchical:{enabled:true,direction:"UD",levelSeparation:180,nodeSpacing:150}},physics:false,nodes:{shape:"box",font:{color:"#e5e7eb",size:14},color:{background:"#020617",border:"#4b5563"}},edges:{color:"#6b7280",arrows:{to:{enabled:true,scaleFactor:.7}}}};
  const c=document.getElementById("graph");
  network=new vis.Network(c,data,opts);
  network.on("click",e=>{if(e.nodes.length)selectCourse(e.nodes[0]);});
}

/* === PREREQS & FUTURE COURSES === */
function getPrereqs(start){
  const direct=new Set(),indirect=new Set(),vis=new Set();
  (courseMeta[start]?.prereqs||[]).forEach(p=>{if(programCodes.has(p)){direct.add(p);vis.add(p);}});
  const q=[...direct];
  while(q.length){
    const c=q.shift();
    for(const p of(courseMeta[c]?.prereqs||[]))
      if(programCodes.has(p)&&!vis.has(p)){indirect.add(p);vis.add(p);q.push(p);}
  }
  return{direct,indirect};
}

function getFutureCourses(start){
  const future=new Set(),vis=new Set([start]);
  const q=[start];
  while(q.length){
    const c=q.shift();
    for(const[k,m]of Object.entries(courseMeta)){
      if((m.prereqs||[]).includes(c)&&!vis.has(k)&&programCodes.has(k)){
        future.add(k);vis.add(k);q.push(k);
      }
    }
  }
  return future;
}

/* === SELECTION & HIGHLIGHTING === */
function selectCourse(code){
  const {direct,indirect}=getPrereqs(code);
  const future=getFutureCourses(code);
  for(const arr of Object.values(courseEls))
    arr.forEach(el=>el.classList.remove("course-selected","course-direct","course-indirect","course-future"));
  for(const [c,arr]of Object.entries(courseEls))
    arr.forEach(el=>{
      if(toggles.selected.checked&&c===code)el.classList.add("course-selected");
      else if(toggles.direct.checked&&direct.has(c))el.classList.add("course-direct");
      else if(toggles.indirect.checked&&indirect.has(c))el.classList.add("course-indirect");
      else if(toggles.future.checked&&future.has(c))el.classList.add("course-future");
    });
  recolorGraph(code,direct,indirect,future);
}

async function buildMiniGraph(courseCode) {
  // Ensure metadata for searched course
  if (!courseMeta[courseCode]) {
    const doc = await db.collection("courses").doc(`${courseCode}_${currentYear}`).get();
    if (doc.exists) courseMeta[courseCode] = doc.data();
    else {
      const base = await db.collection("courses").doc(courseCode).get();
      courseMeta[courseCode] = base.exists ? base.data() : { prereqs: [] };
    }
  }

  // --- gather all connections recursively ---
  const { direct, indirect } = getPrereqs(courseCode);
  const future = getFutureCourses(courseCode);
  const related = new Set([courseCode, ...direct, ...indirect, ...future]);

  // collect nodes + edges
  const nodes = [];
  const edges = [];
  for (const c of related) {
    nodes.push({ id: c, label: c });
    const prereqs = courseMeta[c]?.prereqs || [];
    for (const p of prereqs) {
      if (related.has(p)) edges.push({ from: p, to: c, arrows: "to" });
    }
  }

  // --- build mini graph layout ---
  const container = document.getElementById("mini-graph");
  container.innerHTML = `
    <div style="display:flex;gap:0.75rem;justify-content:center;
                font-size:0.8rem;color:#94a3b8;margin-bottom:0.4rem;flex-wrap:wrap;">
      <label><input type="checkbox" id="mini-toggle-selected" checked>Selected</label>
      <label><input type="checkbox" id="mini-toggle-direct" checked>Direct</label>
      <label><input type="checkbox" id="mini-toggle-indirect" checked>Indirect</label>
      <label><input type="checkbox" id="mini-toggle-future" checked>Future</label>
    </div>
    <div id="mini-graph-inner"
         style="height:350px;border:1px solid var(--border);
                border-radius:0.6rem;background:#020617;"></div>
  `;

  const data = {
    nodes: new vis.DataSet(nodes),
    edges: new vis.DataSet(edges)
  };

  const opts = {
    layout: {
      hierarchical: {
        enabled: true,
        direction: "UD",
        levelSeparation: 180,
        nodeSpacing: 130
      }
    },
    physics: false,
    nodes: {
      shape: "box",
      font: { color: "#e5e7eb", size: 13 },
      color: { background: "#020617", border: "#4b5563" }
    },
    edges: {
      color: "#6b7280",
      arrows: { to: { enabled: true, scaleFactor: 0.7 } }
    }
  };

  const net = new vis.Network(
    document.getElementById("mini-graph-inner"),
    data,
    opts
  );

  // --- color logic matching main graph ---
  const toggleSelected = document.getElementById("mini-toggle-selected");
  const toggleDirect = document.getElementById("mini-toggle-direct");
  const toggleIndirect = document.getElementById("mini-toggle-indirect");
  const toggleFuture = document.getElementById("mini-toggle-future");

  function recolorMini() {
    nodes.forEach(n => {
      let bg = "#020617", bd = "#4b5563";
      if (toggleSelected.checked && n.id === courseCode) {
        bg = "#9a3412"; bd = "#f97316";
      } else if (toggleDirect.checked && direct.has(n.id)) {
        bg = "#14532d"; bd = "#22c55e";
      } else if (toggleIndirect.checked && indirect.has(n.id)) {
        bg = "#082f49"; bd = "#38bdf8";
      } else if (toggleFuture.checked && future.has(n.id)) {
        bg = "#1e1b4b"; bd = "#a78bfa";
      }
      data.nodes.update({ id: n.id, color: { background: bg, border: bd } });
    });
  }

  [toggleSelected, toggleDirect, toggleIndirect, toggleFuture]
    .forEach(t => t.onchange = recolorMini);

  recolorMini();
}

function recolorGraph(sel,dir,indir,future){
  if(!nodeSet)return;
  nodeSet.forEach(n=>{
    let bg="#020617",bd="#4b5563";
    if(toggles.selected.checked&&n.id===sel){bg="#9a3412";bd="#f97316";}
    else if(toggles.direct.checked&&dir.has(n.id)){bg="#14532d";bd="#22c55e";}
    else if(toggles.indirect.checked&&indir.has(n.id)){bg="#082f49";bd="#38bdf8";}
    else if(toggles.future.checked&&future.has(n.id)){bg="#1e1b4b";bd="#a78bfa";}

    nodeSet.update({id:n.id,color:{background:bg,border:bd}});
  });
}

for(const k in toggles){
  toggles[k].onchange=()=>{
    const sel=document.querySelector(".course-selected")?.dataset?.code;
    if(sel)selectCourse(sel);
  };
}

/* === RATING CIRCLES HELPERS === */
function setSelectedRating(kind, value){
  let container, label;
  if(kind==="diff"){ container=optsDiff; label=valDiff; }
  else if(kind==="work"){ container=optsWork; label=valWork; }
  else { container=optsEnjoy; label=valEnjoy; }
  if(!container||!label) return;
  const buttons = container.querySelectorAll(".rating-circle");
  buttons.forEach(btn=>{
    const v = parseInt(btn.dataset.value,10);
    btn.classList.toggle("selected", v===value);
  });
  label.textContent = value ? String(value) : "–";
}

function attachRatingHandlers(container, kind){
  if(!container) return;
  container.querySelectorAll(".rating-circle").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const v = parseInt(btn.dataset.value,10);
      if(kind==="diff") currentDiff = v;
      else if(kind==="work") currentWork = v;
      else currentEnjoy = v;
      setSelectedRating(kind, v);
    });
  });
}

attachRatingHandlers(optsDiff,"diff");
attachRatingHandlers(optsWork,"work");
attachRatingHandlers(optsEnjoy,"enjoy");

/* === MODAL LOGIC === */
async function openCourseModal(code, name){
  currentModalCourse = code;


// === Log course selection ===
logEvent(analytics, 'major_selected', {
  course_code: code,
  course_name: name || null
});


  // === Ensure course metadata exists ===
  if (!courseMeta[code]) {
    // Try current year first
    const docYear = await db.collection("courses").doc(`${code}_${currentYear || ""}`).get();
    if (docYear.exists) {
      courseMeta[code] = docYear.data();
    } else {
      // fallback to generic
      const docBase = await db.collection("courses").doc(code).get();
      courseMeta[code] = docBase.exists ? docBase.data() : { prereqs: [], description: "No description available yet." };
    }
  }

  const meta = courseMeta[code] || {};
  const desc = meta.description || meta.desc || "No description available yet.";
  let displayName = meta.name || meta.title || name || "";

  // try to extract name like "Programming" from description if missing
  if (!displayName && meta.description) {
    const match = meta.description.match(/^[A-Z]{3,4}\*?\d{4}\s+([^\(]+)/i);
    if (match && match[1]) displayName = match[1].trim();
  }

  // avoid duplicates (CIS*1300 – CIS*1300)
  modalTitle.textContent = displayName && displayName !== code ? `${code} – ${displayName}` : code;
  modalDesc.textContent = cleanDescription(desc);

  // reset chosen ratings
  currentDiff = null;
  currentWork = null;
  currentEnjoy = null;
  setSelectedRating("diff", null);
  setSelectedRating("work", null);
  setSelectedRating("enjoy", null);

  // placeholders for averages
  avgDiffEl.textContent = "–";
  avgWorkEl.textContent = "–";
  avgEnjoyEl.textContent = "–";
  document.getElementById("rating-count").textContent = "as rated by 0 users";

  document.body.classList.add("modal-open");
  modal.style.display = "flex";

  // Build mini-graph safely
  await buildMiniGraph(code);
  loadCourseRatings(code).catch(()=>{});
}

function closeCourseModal(){
  modal.style.display = "none";
  document.body.classList.remove("modal-open");
}

modalClose.onclick = closeCourseModal;
modal.addEventListener("click", (e)=>{
  if(e.target === modal) closeCourseModal();
});

/* === UNIVERSAL COURSE RATINGS (no year in doc id) === */
async function loadCourseRatings(code){
  // ratings are stored under courses/{code}/ratings
  const ratingsRef = db.collection("courses").doc(code).collection("ratings");
  const snap = await ratingsRef.get();

  let dSum=0,dCount=0,wSum=0,wCount=0,eSum=0,eCount=0;

  snap.forEach(doc=>{
    const r = doc.data();
    if(typeof r.difficulty === "number"){ dSum+=r.difficulty; dCount++; }
    if(typeof r.workload === "number"){ wSum+=r.workload; wCount++; }
    if(typeof r.enjoyability === "number"){ eSum+=r.enjoyability; eCount++; }
  });

  avgDiffEl.textContent = dCount ? (dSum/dCount).toFixed(1) : "–";
  avgWorkEl.textContent = wCount ? (wSum/wCount).toFixed(1) : "–";
  avgEnjoyEl.textContent = eCount ? (eSum/eCount).toFixed(1) : "–";
  document.getElementById("rating-count").textContent = `as rated by ${Math.max(dCount, wCount, eCount)} users`;

  // Load this browser's previous rating if exists
  const myDoc = await ratingsRef.doc(raterId).get();
  if(myDoc.exists){
    const r = myDoc.data();
    if(typeof r.difficulty === "number"){ currentDiff = r.difficulty; setSelectedRating("diff", currentDiff); }
    if(typeof r.workload === "number"){ currentWork = r.workload; setSelectedRating("work", currentWork); }
    if(typeof r.enjoyability === "number"){ currentEnjoy = r.enjoyability; setSelectedRating("enjoy", currentEnjoy); }
  }
}

ratingSubmit.onclick = async ()=>{
  if(!currentModalCourse) return;

  if(!currentDiff || !currentWork || !currentEnjoy){
    setStatus("Please choose ratings for difficulty, workload, and enjoyability.", true);
    return;
  }

  const code = currentModalCourse;
  // universal rating doc (no year)
  const ratingsRef = db.collection("courses").doc(code).collection("ratings");
  const payload = {
    difficulty: currentDiff,
    workload: currentWork,
    enjoyability: currentEnjoy,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  };
  try{
    await ratingsRef.doc(raterId).set(payload);
    await loadCourseRatings(code);
    setStatus("Rating saved.");
  }catch(e){
    console.error(e);
    setStatus("Failed to save rating", true);
  }
};

buildIndex().catch(e=>{console.error(e);setStatus("Load failed",true);});
// === Auto-load a default program on page load ===
window.addEventListener("load", async () => {
  // Wait a bit for buildIndex() to finish populating dropdowns
  setTimeout(async () => {
    const defaultYear = "2025-2026";      // change to whichever you want
    const defaultProgram = "computer-science-cs_coop_2025-2026"; // Firestore doc ID
    if (programsByYear[defaultYear]) {
      yearSel.value = defaultYear;
      populatePrograms();
      progSel.value = defaultProgram;
      currentYear = defaultYear;
      currentProg = defaultProgram;
      setStatus("Auto-loading default program...");
      try {
        const doc = await db.collection("programs").doc(defaultProgram).get();
        if (doc.exists) {
          renderSchedule(doc.data().semesters || []);
          await loadCourseMeta(defaultYear);
          buildGraph();
          summary.innerHTML = `<b>Computer Science (Co-op)</b> · ${defaultYear}`;
          setStatus("Default program loaded.");
        }
      } catch (e) {
        console.error(e);
        setStatus("Failed to auto-load default program", true);
      }
    }
  }, 1500);
});

// how-to modal
const howtoModal = document.getElementById("howto-modal");
const howtoBtn = document.getElementById("howto-btn");
const howtoClose = document.getElementById("howto-close");

howtoBtn.onclick = () => howtoModal.style.display = "flex";
howtoClose.onclick = () => howtoModal.style.display = "none";
howtoModal.addEventListener("click", e => { if (e.target === howtoModal) howtoModal.style.display = "none"; });

// === Search Course Modal ===
const searchModal = document.getElementById("search-modal");
const searchBtn = document.getElementById("search-btn");
const searchClose = document.getElementById("search-close");
const searchInput = document.getElementById("search-input");
const searchSubmit = document.getElementById("search-submit");
const searchStatus = document.getElementById("search-status");

searchBtn.onclick = () => {
  searchModal.style.display = "flex";
  searchInput.value = "";
  searchStatus.textContent = "";
  searchInput.focus();
};

searchClose.onclick = () => searchModal.style.display = "none";
searchModal.addEventListener("click", e => {
  if (e.target === searchModal) searchModal.style.display = "none";
});

function normalizeCourseCode(input) {
  return input.toUpperCase().replace(/\s|\*/g, "");
}

searchSubmit.onclick = async () => {
  const raw = searchInput.value.trim();
  if (!raw) {
    searchStatus.textContent = "Please enter a course code.";
    return;
  }

  const normalized = normalizeCourseCode(raw);
  searchStatus.textContent = "Searching...";
  let found = null;

  try {
    // Try to find a matching course in Firestore
    const coursesSnap = await db.collection("courses").get();
    for (const doc of coursesSnap.docs) {
      const id = doc.id.toUpperCase().replace(/\s|\*/g, "");
      if (id === normalized || id.startsWith(normalized + "_")) {
        found = doc.id.split("_")[0];
        break;
      }
    }

    if (!found) {
      searchStatus.textContent = "Course not found.";
      return;
    }

    searchStatus.textContent = "Loading...";
    searchModal.style.display = "none";

// === Log search event to Firebase Analytics ===
logEvent(analytics, 'major_search', {
  query: raw,
  normalized_code: normalized,
  found_course: found
});

    let courseName = found;
    let description = "";

    // Try to get description
    const courseDoc = await db.collection("courses").doc(found).get();
    if (courseDoc.exists) {
      const data = courseDoc.data();
      description = data.description || "";
      // Extract readable name from description (e.g. "Programming")
      const match = description.match(/^[A-Z]{3,4}\*?\d{4}\s+([^.:\n]+)/i);
      if (match && match[1]) courseName = match[1].trim();
    }

    // Fallback: check program docs for a proper name
    if (courseName === found) {
      const programsSnap = await db.collection("programs").get();
      for (const doc of programsSnap.docs) {
        const prog = doc.data();
        if (!prog.semesters) continue;
        for (const sem of prog.semesters) {
          if (!sem.courses) continue;
          for (const c of sem.courses) {
            if (
              (c.code && c.code.toUpperCase().replace(/\s|\*/g, "") === found.toUpperCase().replace(/\s|\*/g, "")) ||
              (c.text && c.text.toUpperCase().includes(found.toUpperCase().replace(/\s|\*/g, "")))
            ) {
              if (c.name) courseName = c.name;
              break;
            }
          }
        }
      }
    }

    await openCourseModal(found, courseName);

  } catch (err) {
    console.error(err);
    searchStatus.textContent = "Error loading course data.";
  }
};
</script>
</body>
</html>
